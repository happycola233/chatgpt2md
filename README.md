# ChatGPT聊天记录导出为Markdown

将 **ChatGPT 导出 JSON** 转换为可读性极高的 **Markdown**：自动把同一轮推理中出现的 `thoughts` / `assistant code` / `reasoning_recap` 合并为一个可折叠的 `<details>` 区块，并将其插入到“下一条助手文本”的正文最前面；还支持 **数学公式美化** 与 **代码推理整段引用渲染**。

> 适用于：复盘模型推理、归档对话、技术博客记录、审计与分享。

---

## 目录

* [特性](#特性)
* [安装与环境](#安装与环境)
* [使用方法](#使用方法)

  * [交互式（无命令行参数）](#交互式无命令行参数)
  * [最简命令行](#最简命令行)
  * [指定输入与输出路径](#指定输入与输出路径)
  * [命令行帮助](#命令行帮助)
  * [路径带空格/引号](#路径带空格引号)
  * [拖拽打开（Windows）](#拖拽打开windows)
* [输入文件来源](#输入文件来源)

  * [如何获取 JSON 文件+操作步骤](#如何获取-json-文件操作步骤)
* [输出示例](#输出示例)
* [渲染与规则](#渲染与规则)

  * [推理折叠块](#推理折叠块)
  * [数学美化](#数学美化)
  * [代码推理整段引用](#代码推理整段引用)
* [错误与排错](#错误与排错)
* [已知限制](#已知限制)
* [开发说明](#开发说明)
* [Roadmap](#roadmap)
* [协议与免责声明](#协议与免责声明)
* [致谢](#致谢)

---

## 特性

* ✅ **最终态分支**：仅沿 `current_node` 回溯到根，输出“从根到叶”的最终可见对话路径。
* ✅ **推理合并**：将同一轮的

  * `thoughts`（支持多段，含 `summary` 与 `content`）
  * `assistant code`（自动配对紧随其后的 tool `execution_output`）
  * `reasoning_recap`
    合并为一个 `<details>` 折叠区块，**按时间升序**排列子项。
* ✅ **代码推理整段引用**：标题、代码围栏、运行结果围栏全部置于引用（每行以 `>` 开头），阅读体验统一。
* ✅ **数学美化**（跳过代码围栏，包含“引用内代码围栏”）：

  * 行内 `\( ... \)` → `$ ... $`
  * 显示 `\[` … `\]` → `$$` 块（列表项中整体缩进两格）
* ✅ **推理块与正文之间自动空一行**，版式更稳。
* ✅ **纯标准库**，零依赖。
* ✅ **CLI + 交互式输入**：既可 `chatgpt2md input.json`，也可直接运行后手动输入路径。
* ✅ **路径容错**：自动处理带空格与带引号的路径，支持 `~` 与环境变量展开。

---

## 安装与环境

* Python **3.8+**（建议 3.10+）
* 无三方依赖，clone 本仓库即可使用：


---

## 使用方法

### 交互式（无命令行参数）

```bash
python chatgpt2md.py
```

程序会提示你输入 ChatGPT 导出 JSON 的路径（可带引号）。输出会写到**同目录**、**同名**的 `.md` 文件。

### 最简命令行

```bash
python chatgpt2md.py path/to/conversation.json
# 输出：path/to/conversation.md
```

> 提示：输入文件扩展名不必一定是 `.json`，**只要文件内容是 JSON**，`.txt` 也可。

### 指定输入与输出路径

* 位置参数：

```bash
python chatgpt2md.py path/to/input.json path/to/output.md
```

* 或使用选项：

```bash
python chatgpt2md.py -i path/to/input.json -o path/to/output.md
```

### 命令行帮助

```bash
python chatgpt2md.py -h
```

会展示所有参数与示例。

### 路径带空格/引号

以下写法均可（Windows / macOS / Linux）：

```bash
python chatgpt2md.py "C:\path with space\input.json"
python chatgpt2md.py -i "~/Downloads/input.txt" -o "%USERPROFILE%/Desktop/output.md"
```

程序会自动去掉首尾引号，并展开 `~` 与环境变量。

### 拖拽打开（Windows）

你也可以把包含 JSON 的 `TXT` 文件**拖动到本程序**（`chatgpt2md.py`）图标上打开。程序会把该拖入的文件路径作为输入，并在同目录下生成 `.md`。

---

## 输入文件来源

建议直接从 ChatGPT 网页端抓取 **包含完整对话树的 JSON**（见下文步骤），或使用其他导出工具得到等价结构（需包含 `mapping`、`current_node`、`message` 等字段）。

### 如何获取 JSON 文件+操作步骤

1. 在 GPT 对话聊天界面，鼠标右键，点击” **检查** “或” **开发人员选项** ”，或直接按 **F12**。
   ![Screenshot](res/1.png)
2. 在弹出的窗口（后续简称 **开发者窗口**）中，选择“ **网络** ”选择卡。
   ![Screenshot](res/2.png)
3. 复制聊天中自己发送或GPT回复的一小段内容（便于后续搜索）。
   ![Screenshot](res/3.png)
4. 刷新网页（Ctrl+R），请注意，刷新时，**之前打开的开发者窗口不能关闭**。
5. 此时，开发者窗口中应该出现了很多网络请求。点击一下开发者窗口的空白区域（或随便点一个网络请求），确保窗口焦点在开发者窗口上。
6. 按 “Ctrl+F”，粘贴刚刚复制的消息，然后Enter进行搜索，点击搜索出来的结果（如果出现了多个结果，请自行辨别哪个是与自己聊天记录相关的内容。
   ![Screenshot](res/4.png)
7. 如图所示，在Json区域，按 **Ctrl+A** 全选内容，复制。
   ![Screenshot](res/5.png)
8. 在本地新建一个文本文档（TXT），然后粘贴刚刚复制的内容，保存。（**建议不要用默认名称“新建 文本文档.txt”， 防止后续程序覆盖了您的重要文件！！！**）
9. 把该 TXT 拖动到本程序上打开，或使用命令行 `chatgpt2md.exe <path/to/conversation.json>`（文件扩展名无需改成 json，txt 也可以）
   ![Screenshot](res/6.png)
10. 此时应该可以看到，在TXT同目录下，创建一个与该TXT同名的Markdown文件。（**请注意，如果您原本有同名的重要.md文件，请备份，本程序生成操作会覆盖！！！**）

---

## 输出示例

推理（thoughts + 代码 + 运行结果 + recap）会被折叠到一个 `<details>` 中，并插入到其后的 **第一条助手文本** 的正文前方；推理块与正文之间**空一行**。

````markdown
# ChatGPT
> 时间：2025-08-27 12:34:56

<details>
<summary>已思考 49s</summary>

> **解释电池容量转换和充电效率**
> ```python
> energy_wh = 72.0
> usb_wh = 11.52 * 5.0
> ...
> ```
> ```
> (57.6, 0.8, 23.22, 0.72, 0.576, 0.5184, 2.232558...)
> ```

> **数学示例**
> > 行内数学会被美化如 \(E=mc^2\) → $E=mc^2$
> > 显示数学 \[ a^2 + b^2 = c^2 \] → $$ 块
</details>

正文从这里开始……
````

---

## 渲染与规则

### 推理折叠块

* 子项按 **(时间, 进入序)** 升序：

  * `thought`：输出

    * `> **summary**`
    * `content` 逐行引用，并进行**数学美化**（跳过代码围栏）
  * `code`：输出

    * `> **标题**`（若无则使用“代码推理”）
    * 代码围栏与运行结果围栏统一放在**同一个引用块**中
* 若遍历结束仍有未输出的会话，将其作为**单独一条助手消息**输出（仅 `<details>`）。

### 数学美化

* 行内：`\( ... \)` → `$ ... $`
* 显示：独立行 `\[` … `\]` → `$$` 块，并在列表项中整体**缩进两格**，前后各空一行。
* **跳过代码围栏**（包括 **引用内的代码围栏** 形如 `> ```python`），避免误替换。
* 不反转义 `\~` 与 `\@`。

### 代码推理整段引用

* `_render_code_run()` 生成的代码推理段，**整段**走 `_to_blockquote()`，保证标题、代码围栏、运行结果围栏行行都有 `>`。
* `beautify_markdown()` 使用 `_FENCE_RE` 识别 `> ```...` 这种**引用内围栏**，从而在美化阶段跳过代码内容。

---

## 错误与排错

* **JSON 解析失败**：确认复制的内容完整（`mapping`、`current_node` 存在），文件编码为 UTF-8。
* **输出覆盖**：程序会**直接覆盖**目标 `.md`，请预先备份同名文件。
* **VSCode / Pylance 类型提示**：已使用 `from __future__ import annotations` 与 `tuple[Optional[str], Optional[str]]`，避免 `reportInvalidTypeForm`。
* **SyntaxWarning（无效转义）**：源码 docstring 使用原始字符串 `r"""..."""`，避免 `\(`/`\[` 告警。

---

## 已知限制

* 仅处理 **最终态分支**（由 `current_node` 回溯构建），不会遍历所有分叉版本。
* 仅渲染 `content.content_type in {"text","multimodal_text"}` 的 **用户/助手消息**；其他类型（例如文件、图片二进制）不会直接输出。
* `tool` 输出仅自动配对 **python 执行结果**（`author.name == "python"` 且 `execution_output`）。
* 针对 Markdown 渲染差异，不同平台/预览器可能存在细微表现差别。

---

## 开发说明

* 代码为 **纯标准库** 实现，无外部依赖。
* 核心模块：

  * `beautify_markdown()`：数学美化（避开代码围栏/引用内围栏）。
  * `ReasoningSession`：聚合 thoughts/code/reasoning\_recap；在遇到助手文本时“落盘”到 `<details>`。
  * CLI/交互：支持 **位置参数**、**-i/-o 选项**、**交互式输入**、**路径去引号与展开**。
* 风格：

  * 尽量纯函数化与小粒度方法；注释详尽，避免“屎山”。

---

## Roadmap

* [ ] 可选输出：**完整分叉树**（不仅最终态）
* [ ] 可选模板：如“把 `<details>` 放在消息末尾”
* [ ] 导出时的图片/文件 URL 处理与占位
* [ ] 可配置的数学美化开关与样式

---

## 协议与免责声明

* 本工具用于**个人备份与阅读优化**。请遵守相关平台的服务条款与隐私政策，不要公开分享含有敏感信息的导出内容。
* 代码与文档以 **MIT License** 发布。

---

## 致谢

* 灵感来源于大家对“可读的推理记录”的共同诉求。
* 感谢所有反馈者的建议与测试。

---

### Star & Issue

如果本工具对你有帮助，请点个 ⭐️。有问题或建议，欢迎提 Issue！
